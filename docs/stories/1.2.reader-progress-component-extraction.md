# Story 1.2: Reader Progress Component Extraction

## Status
Approved

## Story
**As a** developer working on reader features,
**I want** to extract progress tracking logic into a dedicated ReaderProgressTracker component,
**so that** progress functionality is isolated and can be tested independently.

## Acceptance Criteria
1. Create `src/features/reader/components/ReaderProgressTracker.tsx` component
2. Move all progress-related state and useEffect hooks from ReaderPage.tsx
3. Implement `useReaderProgress` hook for progress-specific logic
4. Progress restoration functionality works identically to current implementation
5. Intersection Observer logic for progress tracking is encapsulated within the new component

## Integration Verification
IV1: Verify reading progress is saved and restored identically to current behavior
IV2: Test progress tracking across different reading speeds and scroll behaviors
IV3: Confirm memory usage for progress tracking does not increase

## Tasks / Subtasks
- [ ] Task 1: Analyze Current Progress Logic in ReaderPage (AC: 1, 2)
  - [ ] Document all progress-related useEffect hooks in ReaderPage.tsx
  - [ ] Identify progress-related state variables (currently in ReaderContext)
  - [ ] Map progress restoration logic and scroll handling
  - [ ] Document Intersection Observer usage for progress tracking

- [ ] Task 2: Create useReaderProgress Hook (AC: 3)
  - [ ] Create `src/features/reader/hooks/useReaderProgress.ts`
  - [ ] Extract progress calculation logic from ReaderPage
  - [ ] Implement progress restoration functionality
  - [ ] Handle scroll event processing and throttling
  - [ ] Manage Intersection Observer for section tracking

- [ ] Task 3: Create ReaderProgressTracker Component (AC: 1, 5)
  - [ ] Create `src/features/reader/components/ReaderProgressTracker.tsx`
  - [ ] Implement scroll container monitoring
  - [ ] Encapsulate Intersection Observer logic
  - [ ] Handle progress save-on-unmount functionality
  - [ ] Provide progress data to parent components

- [ ] Task 4: Extract Progress Logic from ReaderPage (AC: 2, 4)
  - [ ] Remove progress-related useEffect hooks from ReaderPage.tsx
  - [ ] Replace direct progress logic with ReaderProgressTracker usage
  - [ ] Update ReaderPage to use progress data from component
  - [ ] Ensure all progress event handlers work through new component

- [ ] Task 5: Integration Testing and Validation (AC: 4, 5)
  - [ ] Test progress restoration on page load works identically
  - [ ] Verify scroll-based progress tracking accuracy
  - [ ] Test progress saving on component unmount
  - [ ] Validate memory usage is not increased
  - [ ] Test progress tracking across different reading speeds

## Dev Notes

### Previous Story Insights
Story 1.1 successfully centralized state management using ReaderContext, moving 8 useState variables and 18 useRef variables from ReaderPage.tsx into a centralized context. The progress-related state is now accessible through the ReaderContext refs system, which provides getter/setter methods for:
- `updateProgressRef` - Progress update mutation
- `latestProgressRef` - Current progress data
- `lastReportedProgressRef` - Last saved progress
- `isRestoringProgressRef` - Progress restoration state
- And other progress-related refs

### Current Progress Logic Analysis

**Progress-Related State (in ReaderContext):**
- Progress update mutations via `updateProgressRef`
- Latest progress tracking via `latestProgressRef`
- Last reported progress via `lastReportedProgressRef`
- Progress restoration state via `isRestoringProgressRef`
- Scroll container reference via `scrollContainerRef`
- Resume scroll percent via `resumeScrollPercentRef`

**Progress Hooks Currently Used:**
- `useProgress(sectionId)` - Fetch current section progress
- `useUpdateProgress()` - Update progress mutation
- `useToggleCompleted()` - Mark sections complete/incomplete
- `useResourceProgress(resourceId)` - Get all progress for resource

**Progress useEffect Logic in ReaderPage.tsx:**
1. **Progress Tracking Setup** (lines 249-257): Sets up progress hooks and context refs
2. **Save-on-Unmount** (lines 264-368): Flushes progress before component unmounts
3. **Global Progress Updates** (lines 375-470): Handles scroll events and progress calculations
4. **Progress Restoration** (lines 479-599): Restores reading position on component mount
5. **Section Change Progress** (lines 601-675): Handles progress when switching sections
6. **URL Progress Integration** (lines 677-713): Updates progress when section changes via URL

**Key Progress Functions:**
- `flushLatestProgress()` - Saves latest progress to database
- `updateGlobalProgress()` - Calculates and updates progress from scroll position
- `getProgressSignature()` - Creates signature for progress change detection
- Progress restoration logic with retry mechanisms
- Scroll percentage calculations and throttling

### Data Models and Progress Types

**Progress Table Structure:**
```typescript
type Progress = Database['public']['Tables']['progress']['Row']
// Includes: id, user_id, resource_section_id, scroll_percent, status, updated_at
```

**Progress Status Values:**
- `not_started` - No progress yet
- `in_progress` - User has started reading
- `completed` - User has finished section

**Repository Pattern:**
Progress operations use `ProgressRepository` class with methods:
- `getByUserAndSection(userId, sectionId)` - Fetch specific progress
- `updateScrollPosition()` - Update scroll percentage
- `markCompleted()` / `markInProgress()` - Change status

### Component Architecture Requirements

**ReaderProgressTracker Component Responsibilities:**
- Monitor scroll container for position changes
- Calculate scroll percentages for current section
- Handle Intersection Observer for section detection
- Manage progress restoration on component mount
- Save progress on scroll or component unmount
- Provide progress data via callbacks or context

**Hook Interface Design:**
```typescript
// Expected useReaderProgress interface
interface UseReaderProgressReturn {
  localScrollPercent: number
  isRestoringProgress: boolean
  updateGlobalProgress: () => void
  flushLatestProgress: () => void
  // Other progress-related functions
}
```

**Component Integration Pattern:**
ReaderProgressTracker should:
- Accept scroll container reference as prop
- Use existing progress hooks (useProgress, useUpdateProgress, etc.)
- Integrate with ReaderContext refs for state management
- Provide progress data through props or context updates
- Handle all scroll event listeners and Intersection Observer

### Project Structure Information

**Target File Locations:**
- Component: `src/features/reader/components/ReaderProgressTracker.tsx`
- Hook: `src/features/reader/hooks/useReaderProgress.ts`
- Tests: `src/features/reader/components/__tests__/ReaderProgressTracker.test.tsx`
- Hook tests: `src/features/reader/hooks/__tests__/useReaderProgress.test.tsx`

**Integration Points:**
- Update: `src/features/reader/pages/ReaderPage.tsx` (remove progress logic)
- Uses: Existing progress hooks from `src/features/progress/hooks/`
- Uses: ReaderContext refs for state management
- Uses: Progress repository from `src/lib/repositories/progress`

### Technical Constraints

**Performance Requirements:**
- Must not increase memory usage compared to current implementation
- Scroll event handling must be properly throttled
- Intersection Observer should be properly cleaned up
- Progress updates should maintain current debouncing behavior

**Functional Constraints:**
- Progress restoration must work identically to current behavior
- All progress tracking edge cases must be preserved
- URL-based progress restoration must continue working
- Progress saving on unmount must be reliable
- Section switching progress handling must be maintained

**Integration Constraints:**
- Must work with existing ReaderContext ref system
- Should use existing progress hooks without modification
- Cannot break existing progress data structure
- Must maintain compatibility with current progress API

### Testing Requirements

**Test File Locations:**
- Component tests: `src/features/reader/components/__tests__/ReaderProgressTracker.test.tsx`
- Hook tests: `src/features/reader/hooks/__tests__/useReaderProgress.test.tsx`
- Integration tests: Update existing `tests/features/reader/ReaderPage.integration.test.tsx`

**Testing Framework and Patterns:**
- Use Vitest for unit testing
- Use React Testing Library for component testing
- Mock Intersection Observer for test reliability
- Test scroll behavior with mock containers
- Test progress restoration with mock data

**Specific Testing Requirements:**
- Test progress calculation accuracy with various scroll positions
- Test progress restoration with different initial states
- Test that scroll events properly trigger progress updates
- Test component cleanup and unmount behavior
- Test error handling for missing or invalid data
- Test performance with large documents and rapid scrolling

### File Structure Alignment
The new component follows established feature-based architecture:
- Components in `src/features/reader/components/`
- Hooks in `src/features/reader/hooks/`
- Tests mirror source structure in `__tests__/` directories
- Follows existing patterns from other reader components

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-18 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
To be determined

### Debug Log References
To be populated during implementation

### Completion Notes List
To be populated during implementation

### File List
To be populated during implementation

## QA Results

### Review Date: TBD

### Reviewed By: TBD

### Code Quality Assessment
To be completed after implementation

### Compliance Check
- Coding Standards: ✓ To be verified
- Project Structure: ✓ To be verified
- Testing Strategy: ✓ To be verified
- All ACs Met: ✓ To be verified

### Gate Status
To be determined after implementation