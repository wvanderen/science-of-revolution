# Story 3.1: Shared Notes Database Schema

## Status
Draft

## Story
**As a** system designer,
**I want** to extend the highlights system to support shared annotations,
**so that** users can collaborate on reading materials through shared insights.

## Acceptance Criteria
1. Add visibility_level and cohort_id columns to existing highlights table
2. Create shared_notes_view database view for efficient querying
3. Implement proper RLS policies for shared notes access control
4. Create repository functions for shared notes operations
5. Update database types and ensure type safety for new fields

## Integration Verification
IV1: Verify existing highlights continue to work without modification
IV2: Test shared notes access controls work correctly for different visibility levels
IV3: Confirm database queries perform efficiently with shared notes data

## Tasks / Subtasks
- [ ] Task 1: Database Schema Migration for Shared Notes Support (AC: 1)
  - [ ] Create migration file following naming pattern: `supabase/migrations/YYYYMMDDNNN_shared_notes_schema.sql`
  - [ ] Add `cohort_id` column to `highlights` table as nullable UUID with foreign key to cohorts
  - [ ] Add `visibility_level` column (rename existing `visibility` or add as alias for backward compatibility)
  - [ ] Create indexes for efficient querying: `idx_highlights_cohort`, `idx_highlights_visibility_cohort`
  - [ ] Add migration rollback instructions in SQL comments
  - [ ] Test migration applies cleanly without breaking existing highlights

- [ ] Task 2: Create Shared Notes Database View (AC: 2)
  - [ ] Design `shared_notes_view` that joins highlights with user_profiles and cohorts
  - [ ] Include all highlight fields plus user display_name, avatar_url, and cohort name
  - [ ] Filter to only show highlights with visibility in ('cohort', 'global')
  - [ ] Add helpful computed columns (e.g., is_author, can_edit based on auth.uid())
  - [ ] Document view purpose and usage in SQL comments
  - [ ] Test view returns correct data for different visibility scenarios

- [ ] Task 3: Implement Row Level Security Policies for Shared Notes (AC: 3)
  - [ ] Update existing highlights RLS policies to account for cohort_id field
  - [ ] Create policy: "Users can read cohort highlights in same cohort" using cohort_id
  - [ ] Create policy: "Users can only set cohort_id for cohorts they belong to"
  - [ ] Ensure private highlights remain private regardless of cohort_id
  - [ ] Test RLS policies prevent unauthorized access across different scenarios
  - [ ] Document each policy's purpose and authorization logic

- [ ] Task 4: Create SharedNotesRepository Class (AC: 4)
  - [ ] Create `src/lib/repositories/sharedNotes.ts` following HighlightsRepository pattern
  - [ ] Implement `getSharedNotesBySectionId(sectionId, cohortId?)` method
  - [ ] Implement `getSharedNotesByCohortId(cohortId)` method
  - [ ] Implement `shareHighlight(highlightId, cohortId, visibility)` method
  - [ ] Implement `unshareHighlight(highlightId)` method (set visibility to private)
  - [ ] Add proper error handling and TypeScript types for all methods
  - [ ] Use shared_notes_view for efficient querying with user/cohort metadata

- [ ] Task 5: Update Database Types and TypeScript Interfaces (AC: 5)
  - [ ] Run `supabase gen types typescript --local > src/lib/database.types.ts`
  - [ ] Verify highlights table Row/Insert/Update types include cohort_id
  - [ ] Create SharedNote TypeScript interface based on shared_notes_view
  - [ ] Update HighlightWithNote type if needed for cohort metadata
  - [ ] Ensure all repository methods use correct generated types
  - [ ] Fix any type errors across the codebase from schema changes

- [ ] Task 6: Update Existing HighlightsRepository for Cohort Support (AC: 1, 4)
  - [ ] Add cohort_id parameter to create() method signature
  - [ ] Update update() method to support changing cohort_id
  - [ ] Modify getSharedBySectionId() to filter by cohort_id when provided
  - [ ] Add getByCohortId() method for cohort-specific highlights
  - [ ] Ensure backward compatibility for existing highlights without cohort_id
  - [ ] Test all repository methods work correctly with new schema

- [ ] Task 7: Database Migration Testing (IV1, IV2, IV3)
  - [ ] Test migration applies successfully on fresh database
  - [ ] Test migration works on database with existing highlights data
  - [ ] Verify existing highlights retain visibility and function correctly
  - [ ] Test RLS policies with different user/cohort combinations
  - [ ] Benchmark query performance for shared_notes_view vs direct table queries
  - [ ] Create test data covering all visibility levels and cohort scenarios

- [ ] Task 8: Unit Testing for SharedNotesRepository (AC: 4, IV2, IV3)
  - [ ] Create `src/lib/repositories/__tests__/sharedNotes.test.ts`
  - [ ] Test getSharedNotesBySectionId with different cohort filters
  - [ ] Test shareHighlight enforces cohort membership
  - [ ] Test visibility filtering works correctly
  - [ ] Test RLS policies through repository methods
  - [ ] Mock Supabase client and test error handling
  - [ ] Achieve >80% code coverage for repository

## Dev Notes

### Previous Story Insights
Story 2.4 successfully completed:
- Established repository pattern with ProfilesRepository following consistent TypeScript patterns
- React Query integration for optimistic updates and cache management working well
- Privacy settings implementation demonstrated proper RLS policy patterns
- Feature-based organization under `src/features/` and shared code under `src/lib/`

Key patterns to follow from previous stories:
- Repository classes in `src/lib/repositories/` with typed Supabase client
- React Query hooks in `src/features/{feature}/hooks/` for data access
- Generated types from `database.types.ts` for type safety
- Comprehensive error handling with proper TypeScript types

### Existing Highlights System Analysis

**Current Highlights Table Schema:**
```sql
-- From migration: 202510131012_milestone1_reader_highlights_schema.sql
create table public.highlights (
    id uuid primary key default gen_random_uuid(),
    user_id uuid not null references public.profiles(id) on delete cascade,
    resource_section_id uuid not null references public.resource_sections(id) on delete cascade,
    start_pos integer not null,
    end_pos integer not null,
    text_content text not null,
    color text not null default 'yellow',
    visibility text not null default 'private' check (visibility in ('private', 'cohort', 'global')),
    created_at timestamptz not null default now(),
    updated_at timestamptz not null default now(),

    constraint valid_highlight_positions check (end_pos > start_pos)
);
```
[Source: supabase/migrations/202510131012_milestone1_reader_highlights_schema.sql lines 27-41]

**Key Observations:**
- ✅ Visibility field already exists with correct enum values ('private', 'cohort', 'global')
- ❌ cohort_id field does NOT exist yet - this is the primary addition needed
- Existing RLS policies reference `user_cohorts` table for cohort membership checks
- Current HighlightsRepository has `getSharedBySectionId()` method that filters by visibility

**Existing RLS Policies:**
```sql
-- Users can read cohort highlights in their cohorts
create policy "Users can read cohort highlights in their cohorts"
    on public.highlights for select
    to authenticated
    using (
        visibility = 'cohort' and exists (
            select 1 from public.user_cohorts uc1
            join public.user_cohorts uc2 on uc1.cohort_id = uc2.cohort_id
            where uc1.user_id = highlights.user_id
            and uc2.user_id = auth.uid()
        )
    );
```
[Source: supabase/migrations/202510131012_milestone1_reader_highlights_schema.sql lines 132-143]

**Current limitation:** This policy allows users to see ALL cohort highlights from ANY cohort they share with the author. Adding cohort_id enables precise cohort-scoped sharing.

### Data Models

**Enhanced Highlights Table Schema (to be created):**
```sql
-- Add cohort_id column to existing highlights table
ALTER TABLE public.highlights
  ADD COLUMN cohort_id uuid REFERENCES public.cohorts(id) ON DELETE SET NULL;

-- Add index for efficient cohort-based queries
CREATE INDEX idx_highlights_cohort ON public.highlights(cohort_id, created_at DESC);
CREATE INDEX idx_highlights_visibility_cohort ON public.highlights(visibility, cohort_id);

-- Add constraint to ensure cohort_id is set when visibility is 'cohort'
ALTER TABLE public.highlights
  ADD CONSTRAINT cohort_visibility_check
  CHECK (
    (visibility = 'cohort' AND cohort_id IS NOT NULL) OR
    (visibility != 'cohort')
  );
```

**Shared Notes View Schema:**
```sql
-- Database view for efficient shared notes querying
CREATE OR REPLACE VIEW shared_notes_view AS
SELECT
  h.id,
  h.user_id,
  h.resource_section_id,
  h.cohort_id,
  h.start_pos,
  h.end_pos,
  h.text_content,
  h.color,
  h.visibility,
  h.created_at,
  h.updated_at,
  p.display_name as author_name,
  p.avatar_url as author_avatar,
  c.name as cohort_name,
  n.content as note_content,
  (h.user_id = auth.uid()) as is_author
FROM public.highlights h
LEFT JOIN public.profiles p ON h.user_id = p.id
LEFT JOIN public.cohorts c ON h.cohort_id = c.id
LEFT JOIN public.notes n ON h.id = n.highlight_id
WHERE h.visibility IN ('cohort', 'global');

COMMENT ON VIEW shared_notes_view IS
  'Materialized view of shared highlights with author and cohort metadata for efficient querying';
```

**TypeScript Interface for SharedNote:**
```typescript
interface SharedNote {
  id: string;
  user_id: string;
  resource_section_id: string;
  cohort_id: string | null;
  start_pos: number;
  end_pos: number;
  text_content: string;
  color: string;
  visibility: 'cohort' | 'global' | 'private';
  created_at: string;
  updated_at: string;
  author_name: string;
  author_avatar: string | null;
  cohort_name: string | null;
  note_content: string | null;
  is_author: boolean;
}
```
[Source: docs/architecture/fullstack-launch-features.md lines 213-228]

**Updated Highlights Table TypeScript Types (after migration):**
```typescript
// From database.types.ts (to be generated)
type Highlight = Database['public']['Tables']['highlights']['Row'] & {
  cohort_id: string | null; // NEW FIELD
}

type HighlightInsert = Database['public']['Tables']['highlights']['Insert'] & {
  cohort_id?: string | null; // NEW FIELD
}
```

### Repository Pattern and Implementation

**SharedNotesRepository Class Structure:**
```typescript
// src/lib/repositories/sharedNotes.ts
import { type SupabaseClient } from '@supabase/supabase-js'
import { type Database } from '../database.types'

type SharedNote = Database['public']['Views']['shared_notes_view']['Row']

export class SharedNotesRepository {
  constructor(private readonly supabase: SupabaseClient<Database>) {}

  /**
   * Get shared notes for a specific section, optionally filtered by cohort
   */
  async getSharedNotesBySectionId(
    sectionId: string,
    cohortId?: string
  ): Promise<SharedNote[]> {
    let query = this.supabase
      .from('shared_notes_view')
      .select('*')
      .eq('resource_section_id', sectionId)
      .order('created_at', { ascending: false })

    if (cohortId) {
      query = query.eq('cohort_id', cohortId)
    }

    const { data, error } = await query
    if (error) throw error
    return data ?? []
  }

  /**
   * Get all shared notes for a specific cohort
   */
  async getSharedNotesByCohortId(cohortId: string): Promise<SharedNote[]> {
    const { data, error } = await this.supabase
      .from('shared_notes_view')
      .select('*')
      .eq('cohort_id', cohortId)
      .order('created_at', { ascending: false })

    if (error) throw error
    return data ?? []
  }

  /**
   * Share a highlight with a specific cohort
   * Updates visibility and sets cohort_id
   */
  async shareHighlight(
    highlightId: string,
    cohortId: string,
    visibility: 'cohort' | 'global' = 'cohort'
  ): Promise<void> {
    // Verify user is member of cohort
    const { data: membership, error: membershipError } = await this.supabase
      .from('user_cohorts')
      .select('cohort_id')
      .eq('cohort_id', cohortId)
      .single()

    if (membershipError || !membership) {
      throw new Error('User is not a member of this cohort')
    }

    const { error } = await this.supabase
      .from('highlights')
      .update({
        visibility,
        cohort_id: cohortId,
        updated_at: new Date().toISOString()
      })
      .eq('id', highlightId)

    if (error) throw error
  }

  /**
   * Make a highlight private (unshare)
   */
  async unshareHighlight(highlightId: string): Promise<void> {
    const { error } = await this.supabase
      .from('highlights')
      .update({
        visibility: 'private',
        cohort_id: null,
        updated_at: new Date().toISOString()
      })
      .eq('id', highlightId)

    if (error) throw error
  }
}
```
[Source: docs/architecture/fullstack-launch-features.md lines 82-83, existing HighlightsRepository pattern]

### Enhanced RLS Policies

**Updated Cohort Highlights Policy:**
```sql
-- Replace existing cohort highlights policy with more precise version
DROP POLICY IF EXISTS "Users can read cohort highlights in their cohorts" ON public.highlights;

CREATE POLICY "Users can read cohort highlights in specific cohort"
  ON public.highlights FOR SELECT
  TO authenticated
  USING (
    visibility = 'cohort'
    AND cohort_id IS NOT NULL
    AND EXISTS (
      SELECT 1 FROM public.user_cohorts
      WHERE cohort_id = highlights.cohort_id
      AND user_id = auth.uid()
    )
  );

COMMENT ON POLICY "Users can read cohort highlights in specific cohort"
  ON public.highlights IS
  'Users can only see cohort highlights from cohorts they are members of, based on explicit cohort_id';
```

**New Policy for Cohort Assignment:**
```sql
-- Ensure users can only share to cohorts they belong to
CREATE POLICY "Users can only share highlights to their cohorts"
  ON public.highlights FOR UPDATE
  TO authenticated
  USING (user_id = auth.uid())
  WITH CHECK (
    user_id = auth.uid() AND (
      cohort_id IS NULL OR
      EXISTS (
        SELECT 1 FROM public.user_cohorts
        WHERE cohort_id = highlights.cohort_id
        AND user_id = auth.uid()
      )
    )
  );

COMMENT ON POLICY "Users can only share highlights to their cohorts"
  ON public.highlights IS
  'Prevents users from sharing highlights to cohorts they are not members of';
```

### File Locations and Project Structure

**Migration Files:**
- `supabase/migrations/YYYYMMDDNNN_shared_notes_schema.sql` - Main migration for schema changes
  - Follow naming pattern: Date (YYYYMMDD) + sequence number (NNN)
  - Example: `20251020001_shared_notes_schema.sql`
  - Include rollback instructions in comments

**Repository Files:**
- `src/lib/repositories/sharedNotes.ts` - New SharedNotesRepository class
- `src/lib/repositories/__tests__/sharedNotes.test.ts` - Unit tests for repository
- `src/lib/repositories/highlights.ts` - UPDATE existing HighlightsRepository

**Type Files:**
- `src/lib/database.types.ts` - REGENERATE using `supabase gen types typescript --local`

**Database Structure References:**
- Existing cohorts table: `src/lib/database.types.ts` lines 12-43
- Existing user_cohorts table: `src/lib/database.types.ts` lines 109-125
- Existing highlights table: see migration `202510131012_milestone1_reader_highlights_schema.sql`

[Source: docs/architecture/fullstack-launch-features.md lines 902-903]

### Migration Pattern and Best Practices

**Migration File Structure (from existing migrations):**
```sql
-- Migration: descriptive_name
-- Created: YYYY-MM-DD HH:MM:SS
-- Description: Clear description of what this migration does

-- ============================================================================
-- SECTION HEADER
-- Description of this section
-- ============================================================================

-- SQL statements here with inline comments

-- ============================================================================
-- ROW LEVEL SECURITY POLICIES
-- ============================================================================

ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "policy name" ON table_name;
CREATE POLICY "policy name" ...

-- ============================================================================
-- TABLE COMMENTS
-- ============================================================================

COMMENT ON TABLE table_name IS 'Description';
COMMENT ON COLUMN table_name.column_name IS 'Description';

-- ============================================================================
-- ROLLBACK INSTRUCTIONS
-- To rollback this migration, execute:
-- [SQL commands to undo changes]
-- ============================================================================
```
[Source: supabase/migrations/202510131012_milestone1_reader_highlights_schema.sql structure]

**Migration Execution:**
```bash
# Apply migration locally
supabase db reset  # Applies all migrations fresh

# Or push to remote
supabase db push
```

### Technical Constraints and Considerations

**Database Constraints:**
- Cohort_id should be nullable to maintain backward compatibility with existing highlights
- Add check constraint to ensure cohort_id is set when visibility = 'cohort'
- Foreign key on cohort_id should use ON DELETE SET NULL to handle cohort deletion gracefully
- Indexes needed for efficient querying: (cohort_id, created_at), (visibility, cohort_id)

**Performance Considerations:**
- shared_notes_view should use LEFT JOINs to include highlights without notes/cohorts
- Indexes on highlights(cohort_id) and highlights(visibility, cohort_id) are critical
- Consider adding partial index: `CREATE INDEX idx_shared_highlights ON highlights(cohort_id, created_at) WHERE visibility IN ('cohort', 'global')`

**Backward Compatibility:**
- Existing highlights without cohort_id should continue to work
- Default visibility remains 'private'
- Repository methods should handle null cohort_id gracefully
- RLS policies must not break existing highlight access patterns

**Type Safety:**
- Run `supabase gen types typescript --local` after migration to update types
- Use generated Database types for all repository methods
- Create custom SharedNote interface for view results
- Ensure all repository methods have proper return types and error handling

## Testing

### Testing Requirements

**Test File Locations:**
- Repository tests: `src/lib/repositories/__tests__/sharedNotes.test.ts`
- Migration tests: Manual testing via `supabase db reset` and verification queries
- Integration tests: Will be added in Story 3.2 when UI components are built

**Testing Framework and Patterns:**
- Use Vitest for unit and integration tests [Source: docs/architecture/fullstack-launch-features.md line 1076]
- Follow existing repository test patterns from HighlightsRepository tests
- Mock Supabase client using vi.mock() for isolated unit tests
- Use test fixtures for different cohort/visibility scenarios

**Test Coverage Requirements:**
- Unit test coverage >80% for SharedNotesRepository
- Test all repository methods with success and error cases
- Test RLS policies with different user/cohort combinations
- Verify migration rollback works correctly

**Specific Testing Requirements:**
- Test cohort_id column is added correctly and accepts null values
- Test shared_notes_view returns correct data for different visibility levels
- Test RLS policies prevent unauthorized access to cohort highlights
- Test SharedNotesRepository methods handle edge cases (null cohort_id, invalid cohort)
- Test existing highlights continue to work after migration
- Test query performance for shared_notes_view vs direct table access

**Migration Testing Checklist:**
```sql
-- Verify schema changes
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'highlights' AND column_name = 'cohort_id';

-- Verify view exists
SELECT * FROM information_schema.views WHERE table_name = 'shared_notes_view';

-- Verify RLS policies
SELECT policyname, cmd, qual
FROM pg_policies
WHERE tablename = 'highlights' AND policyname LIKE '%cohort%';

-- Test data scenarios
INSERT INTO highlights (user_id, resource_section_id, start_pos, end_pos, text_content, visibility, cohort_id)
VALUES (...); -- Test with and without cohort_id

SELECT * FROM shared_notes_view WHERE cohort_id = 'test-cohort-id';
```

**Repository Test Example Pattern:**
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { SharedNotesRepository } from '../sharedNotes'
import { createClient } from '@supabase/supabase-js'

describe('SharedNotesRepository', () => {
  let repository: SharedNotesRepository
  let mockSupabase: any

  beforeEach(() => {
    mockSupabase = {
      from: vi.fn().mockReturnThis(),
      select: vi.fn().mockReturnThis(),
      eq: vi.fn().mockReturnThis(),
      order: vi.fn().mockResolvedValue({ data: [], error: null })
    }
    repository = new SharedNotesRepository(mockSupabase)
  })

  it('should get shared notes by section id', async () => {
    const mockNotes = [{ id: '1', visibility: 'cohort', cohort_id: 'cohort-1' }]
    mockSupabase.order.mockResolvedValue({ data: mockNotes, error: null })

    const result = await repository.getSharedNotesBySectionId('section-1')

    expect(result).toEqual(mockNotes)
    expect(mockSupabase.from).toHaveBeenCalledWith('shared_notes_view')
    expect(mockSupabase.eq).toHaveBeenCalledWith('resource_section_id', 'section-1')
  })

  it('should filter by cohort when cohortId provided', async () => {
    await repository.getSharedNotesBySectionId('section-1', 'cohort-1')

    expect(mockSupabase.eq).toHaveBeenCalledWith('cohort_id', 'cohort-1')
  })

  it('should throw error when sharing to non-member cohort', async () => {
    mockSupabase.from.mockReturnValue({
      select: vi.fn().mockReturnThis(),
      eq: vi.fn().mockReturnThis(),
      single: vi.fn().mockResolvedValue({ data: null, error: new Error('Not found') })
    })

    await expect(
      repository.shareHighlight('highlight-1', 'cohort-1')
    ).rejects.toThrow('User is not a member of this cohort')
  })
})
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-20 | 1.0 | Initial story creation for shared notes database schema | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
To be populated during implementation

### Debug Log References
To be populated during implementation

### Completion Notes List
To be populated during implementation

### File List
To be populated during implementation

## QA Results
To be populated by QA Agent after implementation
