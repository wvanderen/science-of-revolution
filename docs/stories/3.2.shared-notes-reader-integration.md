# Story 3.2: Shared Notes Reader Integration

## Status
Draft

## Story
**As a** reader,
**I want** to see notes shared by others in my reading interface,
**so that** I can benefit from insights and perspectives shared by my cohort.

## Acceptance Criteria
1. Create SharedNotesPanel component that integrates with ReaderCore
2. Add toggle for shared notes visibility in reader toolbar
3. Display shared highlights with distinct visual styling from personal highlights
4. Implement filtering options (by cohort, by user, by visibility level)
5. Show shared note metadata (author, timestamp, likes if applicable)

## Integration Verification
IV1: Test shared notes display correctly without interfering with personal highlights
IV2: Verify shared notes toggle works smoothly and persists user preference
IV3: Confirm visual distinction between shared and personal notes is clear

## Tasks / Subtasks

- [ ] Task 1: Create SharedNotesPanel Component (AC: 1)
  - [ ] Create `src/features/reader/components/SharedNotesPanel.tsx` component
  - [ ] Implement shared notes list display with author avatars and metadata
  - [ ] Add responsive design for mobile and desktop views
  - [ ] Ensure panel integrates cleanly with existing ReaderCore component
  - [ ] Add loading states and empty state handling

- [ ] Task 2: Integrate SharedNotes Toggle in Reader Toolbar (AC: 2)
  - [ ] Update `src/features/reader/components/ReaderToolbar.tsx` to include shared notes toggle
  - [ ] Implement toggle state management through ReaderContext
  - [ ] Persist shared notes visibility preference in user profile/reading preferences
  - [ ] Add visual feedback for toggle state (on/off indicators)
  - [ ] Ensure toggle doesn't interfere with existing toolbar functionality

- [ ] Task 3: Create Distinct Visual Styling for Shared Highlights (AC: 3)
  - [ ] Design visual differentiation between shared and personal highlights
  - [ ] Use different border colors, opacity, or background patterns for shared highlights
  - [ ] Add author attribution badges on shared highlights
  - [ ] Implement hover effects and interactive states for shared highlights
  - [ ] Ensure accessibility with proper color contrast and focus states

- [ ] Task 4: Implement Shared Notes Filtering System (AC: 4)
  - [ ] Create `src/features/shared-notes/components/SharedNotesFilters.tsx` component
  - [ ] Add cohort filtering dropdown (for users in multiple cohorts)
  - [ ] Add user filtering to show notes from specific cohort members
  - [ ] Implement visibility level filtering (cohort vs global shared notes)
  - [ ] Add search functionality to filter shared notes by content
  - [ ] Persist filter preferences in reading preferences

- [ ] Task 5: Display Shared Note Metadata and Interactions (AC: 5)
  - [ ] Show author information (display name, avatar) on shared notes
  - [ ] Display creation timestamp with relative time formatting
  - [ ] Add like/reaction counts and interaction buttons
  - [ ] Implement basic interaction feedback (like counters, visual states)
  - [ ] Add view count or engagement metrics for shared notes

- [ ] Task 6: Create Shared Notes Hook and Data Management (AC: 1, 4)
  - [ ] Create `src/features/shared-notes/hooks/useSharedNotes.ts` hook
  - [ ] Integrate with existing SharedNotesRepository from Story 3.1
  - [ ] Implement React Query caching for shared notes data
  - [ ] Add real-time subscription hooks for live updates (prepare for Story 3.4)
  - [ ] Handle error states and retry logic for shared notes loading

- [ ] Task 7: Update Reader Context for Shared Notes Integration (AC: 1, 2)
  - [ ] Extend ReaderContext to include shared notes state
  - [ ] Add shared notes visibility toggle state management
  - [ ] Integrate shared notes filters into reader state
  - [ ] Ensure shared notes state persists across reading sessions
  - [ ] Update context provider to handle shared notes data flow

- [ ] Task 8: Responsive Design and Mobile Optimization (AC: 1, 3)
  - [ ] Optimize SharedNotesPanel for mobile view (overlay/slide-out design)
  - [ ] Ensure shared notes don't interfere with reading content on small screens
  - [ ] Add touch-friendly interactions for mobile users
  - [ ] Implement proper viewport handling for shared notes panel
  - [ ] Test across different device sizes and orientations

- [ ] Task 9: Performance Optimization and Caching (AC: 1)
  - [ ] Implement efficient data loading with React Query
  - [ ] Add pagination or virtual scrolling for large numbers of shared notes
  - [ ] Optimize rendering performance for shared highlights in text
  - [ ] Cache shared notes data to reduce unnecessary database queries
  - [ ] Add loading skeletons and smooth transitions for better UX

- [ ] Task 10: Unit Testing for Shared Notes Integration (AC: 1-5)
  - [ ] Create `src/features/reader/components/__tests__/SharedNotesPanel.test.tsx`
  - [ ] Test SharedNotesPanel rendering with different data states
  - [ ] Test toolbar toggle functionality and preference persistence
  - [ ] Test filtering system with various filter combinations
  - [ ] Test shared notes metadata display and interactions
  - [ ] Create integration tests for ReaderContext shared notes state management

## Dev Notes

### Previous Story Insights
Story 3.1 successfully implemented the complete database schema and repository layer for shared notes functionality. The SharedNotesRepository provides methods for accessing shared notes by section and cohort, with proper RLS policies in place.

Key foundations from Story 3.1:
- SharedNotesRepository with cohort-aware data access methods
- Database view (shared_notes_view) with author and cohort metadata
- Proper TypeScript types for shared notes data
- Comprehensive repository testing patterns

### Existing Reader Architecture Integration

**Reader Component Structure (from existing codebase):**
- `ReaderLayoutManager.tsx` - Main layout coordinator
- `ReaderCore.tsx` - Core reading content area
- `ReaderToolbar.tsx` - Reader controls and actions
- `ReaderContext.tsx` - Centralized reader state management

**Integration Points:**
- SharedNotesPanel should integrate with ReaderLayoutManager layout coordination
- ReaderToolbar needs shared notes toggle alongside existing controls
- ReaderContext must be extended to include shared notes state
- Shared notes should overlay alongside reading content without disrupting flow

**Reader Context Extension Pattern (from existing ReaderContext.tsx):**
```typescript
// Existing reader state pattern to follow
interface ReaderState {
  // ... existing state
  sharedNotes: {
    visible: boolean
    notes: SharedNote[]
    filters: SharedNotesFilters
    loading: boolean
  }
}
```

### Shared Notes Data Models

**SharedNote Interface (from Story 3.1 database.types.ts):**
```typescript
type SharedNote = Database['public']['Views']['shared_notes_view']['Row'] & {
  id: string;
  user_id: string;
  resource_section_id: string;
  cohort_id: string | null;
  start_pos: number;
  end_pos: number;
  text_content: string;
  color: string;
  visibility: 'cohort' | 'global' | 'private';
  created_at: string;
  updated_at: string;
  author_name: string;
  author_avatar: string | null;
  cohort_name: string | null;
  note_content: string | null;
  is_author: boolean;
}
```

**Shared Notes Filters Interface:**
```typescript
interface SharedNotesFilters {
  cohortId?: string;
  userId?: string;
  visibility?: 'cohort' | 'global';
  searchQuery?: string;
}
```

### Component Architecture

**SharedNotesPanel Component Structure:**
```typescript
interface SharedNotesPanelProps {
  sectionId: string;
  isVisible: boolean;
  filters: SharedNotesFilters;
  onFiltersChange: (filters: SharedNotesFilters) => void;
  onNoteClick?: (note: SharedNote) => void;
}
```

**Visual Design Requirements:**
- Shared highlights should use distinct colors/borders (e.g., blue tint for cohort, green for global)
- Author attribution with avatar and display name
- Timestamp with relative formatting (e.g., "2 hours ago")
- Interaction indicators (likes, view count)

### File Locations

**New Components:**
- `src/features/reader/components/SharedNotesPanel.tsx` - Main shared notes display panel
- `src/features/shared-notes/components/SharedNotesFilters.tsx` - Filtering controls
- `src/features/shared-notes/components/SharedNoteCard.tsx` - Individual shared note display

**Updated Components:**
- `src/features/reader/components/ReaderToolbar.tsx` - Add shared notes toggle
- `src/features/reader/contexts/ReaderContext.tsx` - Extend state for shared notes
- `src/features/reader/components/ReaderLayoutManager.tsx` - Integrate shared notes panel

**New Hooks:**
- `src/features/shared-notes/hooks/useSharedNotes.ts` - Shared notes data management
- `src/features/shared-notes/hooks/useSharedNotesFilters.ts` - Filter state management

**Test Files:**
- `src/features/reader/components/__tests__/SharedNotesPanel.test.tsx`
- `src/features/shared-notes/hooks/__tests__/useSharedNotes.test.ts`

### Technical Constraints and Considerations

**Performance Requirements:**
- Shared notes loading should not block reading content rendering
- Implement efficient caching with React Query to minimize database queries
- Use virtual scrolling or pagination for sections with many shared notes
- Optimize highlight rendering to avoid layout thrashing

**Integration Constraints:**
- Must not interfere with existing personal highlighting functionality
- Shared notes should complement, not replace, personal annotations
- Reader layout must remain responsive and mobile-friendly
- Accessibility compliance for screen readers and keyboard navigation

**Data Management:**
- Leverage existing SharedNotesRepository from Story 3.1
- Use shared_notes_view for efficient data access with author/cohort metadata
- Implement proper error handling for shared notes loading failures
- Cache shared notes data to improve performance across reading sessions

**State Management:**
- Extend existing ReaderContext rather than creating separate state management
- Persist shared notes preferences in user profile/reading preferences
- Handle real-time updates gracefully (prepare for Story 3.4)
- Manage loading states and error states properly

## Testing

### Testing Requirements

**Unit Testing Strategy:**
- Test SharedNotesPanel component rendering with different data states
- Test toolbar toggle functionality and preference persistence
- Test filtering system with various filter combinations
- Test shared notes metadata display and interaction handlers
- Test ReaderContext state management for shared notes integration

**Integration Testing:**
- Test shared notes panel integration with ReaderLayoutManager
- Test shared notes display within reading content without interference
- Test toggle state persistence across page reloads
- Test filter state management and data filtering accuracy
- Test responsive behavior across different device sizes

**Performance Testing:**
- Test shared notes loading performance with large datasets
- Test memory usage with extensive shared notes data
- Test rendering performance with many shared highlights in text
- Test caching effectiveness and data refresh behavior

**Test File Structure:**
```
src/features/reader/components/__tests__/
├── SharedNotesPanel.test.tsx
└── ReaderToolbar.shared-notes.test.tsx

src/features/shared-notes/hooks/__tests__/
├── useSharedNotes.test.ts
└── useSharedNotesFilters.test.ts

src/features/shared-notes/components/__tests__/
└── SharedNotesFilters.test.tsx
```

**Mock Data Requirements:**
- Mock SharedNotesRepository with realistic shared notes data
- Mock user profile data for author information display
- Mock cohort data for filtering functionality
- Mock reading preferences for persistence testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-20 | 1.0 | Initial story creation for shared notes reader integration | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results

### Review Date: [To be filled by QA Agent]

### Reviewed By: [To be filled by QA Agent]

### Code Quality Assessment
[To be filled by QA Agent]

### Compliance Check
[To be filled by QA Agent]

### Requirements Traceability
[To be filled by QA Agent]

### Test Architecture Assessment
[To be filled by QA Agent]

### Security Review
[To be filled by QA Agent]

### Performance Considerations
[To be filled by QA Agent]

### Non-Functional Requirements Validation
[To be filled by QA Agent]

### Files Modified During Review
[To be filled by QA Agent]

### Gate Status
[To be filled by QA Agent]

### Recommended Status
[To be filled by QA Agent]